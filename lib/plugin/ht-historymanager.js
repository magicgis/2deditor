!function(O,S,Y){"use strict";var E="ht",K=O[E],x=K.Default,r=x.def,W=x.getInternal();K.HistoryManager=function(x){this._histories=[],this.setDataModel(x)},r(K.HistoryManager,S,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var o=this;o._betweenTransaction++,1===o._betweenTransaction&&(o._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var v=this,K=v._histories;v._betweenTransaction>0&&v._betweenTransaction--,0===v._betweenTransaction&&(v._transactionHistories&&v._transactionHistories.length&&(K=K.slice(0,v._historyIndex+1),K.push(v._transactionHistories),K.length>v._maxHistoryCount&&(K=K.slice(K.length-v._maxHistoryCount)),v.setHistories(K),v.setHistoryIndex(K.length-1,!0)),delete v._transactionHistories)}},setDataModel:function(k){var v=this,c=v._dataModel;c!==k&&(c&&(delete c._historyManager,c.ump(v.handleDataModelPropertyChange,v),c.umm(v.$5p,v),c.umd(v.$6p,v),c.removeHierarchyChangeListener(v.handleHierarchyChange,v),c.removeIndexChangeListener(v.handleIndexChange,v)),v._dataModel=k,k&&(k._historyManager=v,k.mp(v.handleDataModelPropertyChange,v),k.mm(v.$5p,v),k.md(v.$6p,v),k.addHierarchyChangeListener(v.handleHierarchyChange,v),k.addIndexChangeListener(v.handleIndexChange,v)),v.fp("dataModel",c,k),v.clear())},setHistoryIndex:function(Z,G){var W=this,s=W._historyIndex,U=W._histories.length;if(-1>Z?Z=-1:Z>=U&&(Z=U-1),s!==Z){if(!G){var E=Z-s;E>0?W.$2p(E):0>E&&W.$1p(-E)}W._historyIndex=Z,W.fp("historyIndex",s,Z),W.dataModel&&W.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(d){var B=this,e=B._histories,M=B._maxHistoryCount;(!d||0>=d)&&(d=10),M!==d&&(B._maxHistoryCount=d,B.fp("maxHistoryCount",M,d),e.length>d&&B.clear())},cloneValue:function(H){return K.Default.clone(H)},isPropertyUndoable:function(s){return s&&!this.ignoredPropertyMap[s]},isDataModelPropertyUndoable:function(O){return O&&!this.ignoreDataModelPropertyMap[O]},$5p:function(T){this.handleChange(T,T.kind)},$6p:function($){this.handleChange($,"property")},handleHierarchyChange:function(I){this.handleChange(I,"hierarchy")},handleIndexChange:function(V){this.handleChange(V,"index")},handleDataModelPropertyChange:function(T){this.handleChange(T,"dataModelProperty")},toChildrenInfo:function(D){var q={};return q.data=D,q.children=[],D.eachChild(function(z){q.children.push(this.toChildrenInfo(z))},this),q},restoreChildren:function(l){var W=l.data;l.children.forEach(function(R){var J=R.data;J.getParent()!==W&&W.addChild(J),this._dataModel.contains(J)||this._dataModel.add(J),this.restoreChildren(R)},this)},handleChange:function(f,P){var q=this;if(!(q._disabled||q._isUndoRedoing||x.loadingRefGraph)){var i,M=(q._histories,f.data),I=f.property;if(!M||!(M._refGraph||M instanceof K.RefGraph)){if("property"===P)q.isPropertyUndoable(I,M)&&(i={kind:P,data:M,property:I,oldValue:q.cloneValue(f.oldValue,M,I),newValue:q.cloneValue(f.newValue,M,I),event:f});else if("hierarchy"===P||"index"===P)i={kind:P,data:M,oldIndex:f.oldIndex,newIndex:f.newIndex,event:f};else if("clear"===P)i={kind:P,json:f.json,event:f};else if("add"===P){if(i={kind:P,data:M,event:f,childrenInfo:this.toChildrenInfo(M),parent:M.getParent()},i.parent){var g=q._dataModel.getSiblings(M);i.siblingsIndex=g.indexOf(M)}M instanceof K.Node&&(i.host=M.getHost(),i.attaches=M.getAttaches()?M.getAttaches().toArray():Y),M instanceof K.Edge&&(i.source=M.getSource(),i.target=M.getTarget())}else"remove"===P?i={kind:P,data:M,event:f}:"dataModelProperty"===P&&q.isDataModelPropertyUndoable(I,M)&&(i={kind:P,property:I,oldValue:q.cloneValue(f.oldValue,M,I),newValue:q.cloneValue(f.newValue,M,I),event:f});q.addHistory(i)}}},addHistory:function(B){var L=this;if(B)if(L._betweenTransaction){var m=!1;if("property"===B.kind||"dataModelProperty"===B.kind)for(var g=L._transactionHistories.length-1;g>=0;g--){var d=L._transactionHistories[g];if(B.kind===d.kind&&B.property===d.property&&B.data===d.data){B.oldValue=d.oldValue,L._transactionHistories[g]=B,m=!0;break}}m||L._transactionHistories.push(B)}else{var k=L._histories;k=k.slice(0,L._historyIndex+1),k.push([B]),k.length>L._maxHistoryCount&&(k=k.slice(k.length-L._maxHistoryCount)),L.setHistories(k),L.setHistoryIndex(k.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(l){(!l||0>=l)&&(l=1),this.setHistoryIndex(this._historyIndex-l)},$1p:function(s){if(this.canUndo()){var L,R=this,E=R._dataModel,l=R._histories,P=R._historyIndex,t=0;for(R._isUndoRedoing=!0,x.setIsolating(!0);s>0;){if(P>=0&&P<l.length){t++,L=l[P],P--;for(var A=L.length-1;A>=0;A--){var j=L[A],c=j.kind,X=j.data,U=j.property,T=j.event,p=this.cloneValue(j.oldValue,X,U);if(j.undo)j.undo();else if("add"===c)E.remove(X,{keepChildren:!0});else if("remove"===c)E.contains(X)||E.add(X,T.rootsIndex,T.datasIndex);else if("clear"===c)E.deserialize(x.clone(j.json));else if("property"===c)if("parent"===U)p?p.addChild(X,T.oldIndex):(X.setParent(p),T.oldIndex>=0&&E.moveTo(X,T.oldIndex));else{var J=null;0===U.indexOf("a:")?(J="attr",U=U.replace("a:","")):0===U.indexOf("s:")?(J="style",U=U.replace("s:","")):0===U.indexOf("f:")&&(J="field",U=U.replace("f:","")),W.setPropertyValue(X,J,U,p)}else if("dataModelProperty"===c){var J=null;0===U.indexOf("a:")?(J="attr",U=U.replace("a:","")):0===U.indexOf("s:")?(J="style",U=U.replace("s:","")):0===U.indexOf("f:")&&(J="field",U=U.replace("f:","")),W.setPropertyValue(E,J,U,p)}else"hierarchy"===c?E.moveTo(X,j.oldIndex):"index"===c&&E.moveToIndex(X,j.oldIndex)}}s--}x.setIsolating(!1),delete R._isUndoRedoing,R.afterUndo(t)}},afterUndo:function(){},redo:function(T){(!T||0>=T)&&(T=1),this.setHistoryIndex(this._historyIndex+T)},$2p:function(Z){if(this.canRedo()){var v,s=this,Y=s._dataModel,o=s._histories,P=s._historyIndex,l=0;for(s._isUndoRedoing=!0,x.setIsolating(!0);Z>0;){if(P>=-1&&P<o.length-1){l++,P++,v=o[P];for(var a=0;a<v.length;a++){var m=v[a],t=m.kind,c=m.data,B=m.property,L=m.event,J=this.cloneValue(m.newValue,c,B);if(m.redo)m.redo();else if("add"===t)m.parent&&!c.getParent()&&m.parent.addChild(c,m.siblingsIndex),Y.contains(c)||Y.add(c,L.rootsIndex,L.datasIndex),this.restoreChildren(m.childrenInfo),c instanceof K.Node&&(c.setHost(m.host),m.attaches&&m.attaches.forEach(function(P){P.setHost(c)})),c instanceof K.Edge&&(c.setSource(m.source),c.setTarget(m.target));else if("remove"===t)Y.remove(c);else if("clear"===t)Y.clear();else if("property"===t)if("parent"===B)J?J.addChild(c,L.newIndex):(c.setParent(J),L.newIndex>=0&&Y.moveTo(c,L.newIndex));else{var G=null;0===B.indexOf("a:")?(G="attr",B=B.replace("a:","")):0===B.indexOf("s:")?(G="style",B=B.replace("s:","")):0===B.indexOf("f:")&&(G="field",B=B.replace("f:","")),W.setPropertyValue(c,G,B,J)}else if("dataModelProperty"===t){var G=null;0===B.indexOf("a:")?(G="attr",B=B.replace("a:","")):0===B.indexOf("s:")?(G="style",B=B.replace("s:","")):0===B.indexOf("f:")&&(G="field",B=B.replace("f:","")),W.setPropertyValue(Y,G,B,J)}else"hierarchy"===t?Y.moveTo(c,m.newIndex):"index"===t&&Y.moveToIndex(c,m.newIndex)}}Z--}x.setIsolating(!1),delete s._isUndoRedoing,this.afterRedo(l)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);